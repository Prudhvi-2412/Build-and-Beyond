<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bid Management System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-dark: #1a365d;
        --secondary-gold: #e9c46a;
        --accent-blue: #3182ce;
        --success-green: #38a169;
        --danger-red: #e53e3e;
        --text-color: #2d3748;
        --light-gray: #f7fafc;
        --border-color: #e1e8f0;
        --status-open: var(--accent-blue);
        --status-awarded: var(--success-green);
        --status-declined: var(--danger-red);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      body {
        background-color: #f8f9fa;
      }
      .container {
        display: flex;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        gap: 20px;
      }

      .section {
        flex: 1;
        background-color: #ffffff;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        padding: 20px;
        height: fit-content;
      }

      .section-title {
        color: var(--primary-dark);
        font-size: 20px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
      }

      .bid-item {
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        background-color: #ffffff;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        border: 1px solid transparent; /* Added for smoother transition */
      }

      .bid-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .bid-item.active {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 2px solid var(--secondary-gold);
        padding: 14px; /* Adjusted padding due to 2px border */
      }

      .project-name {
        font-size: 16px;
        font-weight: 700;
        color: var(--primary-dark);
        margin-bottom: 5px;
      }

      .bid-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .bid-title {
        font-weight: 600;
        color: var(--text-color);
      }

      .bid-price {
        font-weight: 600;
        color: var(--secondary-gold);
      }

      .bid-details {
        font-size: 14px;
        color: #4a5568;
        margin-bottom: 5px;
      }

      .bid-date {
        font-size: 12px;
        color: #718096;
      }

      .company-bid {
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        background-color: var(--light-gray);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .company-bid:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .bid-company {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }

      .company-logo {
        width: 40px;
        height: 40px;
        background-color: var(--success-green);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        margin-right: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12);
        flex-shrink: 0;
      }

      .rating {
        display: flex;
        color: #ecc94b;
        font-size: 14px;
        margin-top: 3px;
      }

      .bid-actions {
        display: flex;
        margin-top: 15px;
        gap: 10px;
      }

      .btn {
        padding: 8px 15px;
        border-radius: 5px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .btn:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        transform: translateY(-1px);
      }

      .btn-accept {
        background-color: var(--success-green);
        color: white;
      }

      .btn-accept:hover {
        background-color: #2f855a;
      }

      .btn-deny {
        background-color: var(--danger-red);
        color: white;
      }

      .btn-deny:hover {
        background-color: #c53030;
      }

      .btn-create {
        background-color: var(--secondary-gold);
        color: var(--primary-dark);
      }

      .btn-create:hover {
        background-color: #eb9c26;
      }
      
      .btn:disabled {
        cursor: default !important;
        opacity: 0.8;
        transform: none !important;
        box-shadow: none !important;
      }
      
      .btn-awarded {
        background-color: var(--success-green) !important;
        color: white !important;
      }

      .btn-already-awarded {
        background-color: #718096 !important;
        color: white !important;
      }
      
      .btn-declined-status {
        background-color: var(--danger-red) !important;
        color: white !important;
      }

      .empty-state,
      .no-bids {
        text-align: center;
        padding: 40px 20px;
        color: #718096;
        background-color: var(--light-gray);
        border-radius: 8px;
        border: 1px dashed var(--border-color);
      }

      .hidden {
        display: none;
      }

      .message-banner {
        background-color: #ebf8ff;
        border-left: 4px solid var(--accent-blue);
        padding: 10px 15px;
        margin-bottom: 15px;
        border-radius: 4px;
        display: flex;
        align-items: center;
      }

      .message-icon {
        color: var(--accent-blue);
        font-size: 18px;
        margin-right: 10px;
      }

      /* New Styles for Detailed Project View */
      .detail-group {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #f0f0f0;
        border-radius: 8px;
        background-color: #fcfcfc;
      }

      .detail-group h3 {
        color: var(--primary-dark);
        font-size: 16px;
        border-bottom: 2px solid var(--secondary-gold);
        padding-bottom: 5px;
        margin-bottom: 10px;
        font-weight: 700;
      }

      .detail-row {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
        margin-bottom: 8px;
      }

      .detail-label {
        font-weight: 600;
        color: #4a5568;
        flex-shrink: 0;
      }

      .detail-value {
        color: var(--text-color);
        max-width: 60%;
        text-align: right;
        word-wrap: break-word; /* Ensure long values wrap */
      }

      .floor-card {
        padding: 10px;
        border: 1px solid #e2e8f0;
        border-left: 4px solid var(--accent-blue);
        border-radius: 4px;
        margin-bottom: 10px;
        background-color: #ffffff;
      }

      .floor-card img {
        max-width: 100%;
        height: auto;
        max-height: 200px;
        margin-top: 10px;
        border-radius: 4px;
        border: 1px solid #ccc;
        display: block;
      }
      .project-details-container{
        overflow-y: scroll;
        scrollbar-width: thin;
        max-height: 60vh;
      }
      .bid-actions{
        display: flex;
        flex-direction: column;
      }
    </style>
  </head>
  <body>
    <%- include('navbar_customer') %>

    <div class="container">
      <div class="section">
        <div class="message-banner">
          <div class="message-icon">ℹ️</div>
          <div class="message-content">
            Manage your project proposals and evaluate competitive bids from
            construction companies.
          </div>
        </div>

        <div class="section-header">
          <h2 class="section-title">Your Project Bids</h2>
          <a href="/bidform"
            ><button class="btn btn-create">Create New Bid</button></a
          >
        </div>

        <div class="bid-list">
          <% if (customerBids && customerBids.length > 0) { %> <%
          customerBids.forEach(bid => { %>
          <div
            class="bid-item"
            onclick="selectBid('<%= bid._id %>')"
            data-bid-id="<%= bid._id %>"
          >
            <div class="project-name"><%= bid.projectName %></div>

            <div class="bid-header">
              <div class="bid-title">
                <%= bid.totalFloors %> Floor | <%=
                bid.buildingType.charAt(0).toUpperCase() +
                bid.buildingType.slice(1) %>
              </div>

              <div class="bid-price">
                Budget: ₹<%= bid.estimatedBudget ?
                bid.estimatedBudget.toLocaleString('en-IN') : 'N/A' %>
              </div>
            </div>

            <div class="bid-details"><%= bid.projectAddress %></div>

            <%
              let statusColor;
              switch (bid.status) {
                case 'open':
                  statusColor = 'var(--status-open)';
                  break;
                case 'awarded':
                  statusColor = 'var(--status-awarded)';
                  break;
                default:
                  statusColor = 'var(--status-declined)';
                  break;
              }
            %>
            <div class="bid-date">
              Status:
              <strong style="color: <%= statusColor %>;"
                ><%= bid.status.charAt(0).toUpperCase() + bid.status.slice(1)
                %></strong
              >
              | Posted: <%= new Date(bid.createdAt).toLocaleDateString('en-IN',
              { month: 'short', day: 'numeric' }) %>
            </div>
          </div>
          <% }); %> <% } else { %>
          <div class="no-bids">
            <p class="no-bids-text">
              You haven't created any bid requests yet. Click **'Create New
              Bid'** to start receiving offers!
            </p>
          </div>
          <% } %>
        </div>
      </div>

      <div class="section">
        <div id="project-details-view" class="hidden">
          <h2 class="section-title" id="dynamic-project-title">
            Project Details
          </h2>
          <div class="project-details-container">
            <div id="dynamic-project-details"></div>
          </div>

          <h2
            class="section-title"
            id="company-bids-title"
            style="margin-top: 20px"
          >
            Company Bids Received
          </h2>
        </div>

        <div id="empty-state" class="empty-state">
          <p>
            Select a project on the left to view its **details** and received
            **company offers**.
          </p>
        </div>

        <% if (customerBids && customerBids.length > 0) { %> <%
        customerBids.forEach(bid => { %>
        <div id="bids-<%= bid._id %>" class="bids-container hidden">
              <% if (bid.companyBids && bid.companyBids.length > 0) { %> 
                <% bid.companyBids.forEach(companyBid => { %>
                  <div class="company-bid">
                    <div class="bid-actions">
                      <h3><%= companyBid.companyName %></h3>
                      <p>Bidded Price : <%= companyBid.bidPrice %></p>
                      <p>Bidded Date : <%= companyBid.bidDate %></p>
                      <% if (bid.winningBidId && bid.winningBidId.toString() === companyBid._id.toString()) { %>
                        <button class="btn btn-awarded" disabled>Project Awarded</button>
                      <% } else if (bid.status === 'awarded') { %>
                        <button class="btn btn-already-awarded" disabled>Already Awarded</button>
                      <% } else if (companyBid.status === 'rejected') { %>
                        <button class="btn btn-declined-status" disabled>Declined</button>
                      <% } else if (bid.status === 'open') { %>
                        <div>
                          <a href="/customer/accept-bid/<%= bid._id %>/<%= companyBid._id %>" class="btn btn-accept">Accept & Pay</a>
                          
                          <button class="btn btn-deny" onclick="declineBid('<%= bid._id %>', '<%= companyBid._id %>')">Decline</button>
                        </div>
                      <% } %>
                    </div>
                  </div>
                <% }); %> 
              <% } else { %>
                <% } %>
            </div>
        <% }); %> <% } %>
      </div>
    </div>
    <%- include('customer_footer') %>
    <script>
      const customerBidsData = <%- JSON.stringify(customerBids || []) %>;
      
      // Function to show details and bids for the selected project
      function selectBid(bidId) {
        const selectedBid = customerBidsData.find(bid => bid._id === bidId);
        
        if (!selectedBid) {
            console.error('Bid data not found for ID:', bidId);
            return; 
        }

        // 1. Handle Active Item in List
        const bidItems = document.querySelectorAll('.bid-item');
        bidItems.forEach(item => {
          item.classList.remove('active');
        });
        const activeItem = document.querySelector(`[data-bid-id="${bidId}"]`);
        activeItem.classList.add('active');

        // 2. Handle Project Details Visibility
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('project-details-view').classList.remove('hidden');

        // 3. Populate Project Details
        // FIX 2: Get the project name text from the active list item
        const projectNameText = activeItem.querySelector('.project-name').textContent.trim();
        document.getElementById('dynamic-project-title').textContent = `${projectNameText || 'Project'} Details`;

        const bidsTitle = document.getElementById('company-bids-title');
        
        const bidCount = selectedBid.companyBids ? selectedBid.companyBids.length : 0;
        bidsTitle.textContent = bidCount > 0
            ? `Company Bids Received (${bidCount})`
            : 'No Bids Received Yet';

        const detailsContainer = document.getElementById('dynamic-project-details');
        detailsContainer.innerHTML = generateProjectDetailsHTML(selectedBid);

        // 4. Handle Company Bids Visibility (Show only the container for the selected bid)
        const bidContainers = document.querySelectorAll('.bids-container');
        bidContainers.forEach(container => {
          container.classList.add('hidden');
        });
        document.getElementById(`bids-${bidId}`).classList.remove('hidden');
      }

      // Helper function to generate the HTML for Project Details
      function generateProjectDetailsHTML(bid) {
        // Helper function for display string normalization
        const toDisplayString = (str) => {
          if (!str) return 'N/A';
          // Converts camelCase or kebab-case to Title Case
          return str.replace(/([A-Z])/g, ' $1').trim().replace(/\b\w/g, c => c.toUpperCase());
        };

        let html = `
          <div class="detail-group">
            <h3>Customer Details</h3>
            <div class="detail-row"><span class="detail-label">Customer Name:</span> <span class="detail-value">${bid.customerName || 'N/A'}</span></div>
            <div class="detail-row"><span class="detail-label">Customer Email:</span> <span class="detail-value">${bid.customerEmail}</span></div>
            <div class="detail-row"><span class="detail-label">Customer Phone:</span> <span class="detail-value">${bid.customerPhone}</span></div>
            <div class="detail-row"><span class="detail-label">Project Address:</span> <span class="detail-value">${bid.projectAddress}</span></div>
          </div>
          <div class="detail-group">
            <h3>Project Overview</h3>
            <div class="detail-row"><span class="detail-label">Building Type:</span> <span class="detail-value">${toDisplayString(bid.buildingType)}</span></div>
            <div class="detail-row"><span class="detail-label">Total Area:</span> <span class="detail-value">${bid.totalArea ? bid.totalArea + ' sq meters' : 'N/A'}</span></div>
            <div class="detail-row"><span class="detail-label">Total Floors:</span> <span class="detail-value">${bid.totalFloors || 'N/A'}</span></div>
            <div class="detail-row"><span class="detail-label">Target Budget:</span> <span class="detail-value">₹${bid.estimatedBudget ? bid.estimatedBudget.toLocaleString('en-IN') : 'Not specified'}</span></div>
            <div class="detail-row"><span class="detail-label">Timeline:</span> <span class="detail-value">${bid.projectTimeline ? bid.projectTimeline + ' months' : 'N/A'}</span></div>
          </div>

          <div class="detail-group">
            <h3>Location & Requirements</h3>
            <div class="detail-row" style="flex-direction: column; align-items: flex-start;"><span class="detail-label">Address:</span> <span class="detail-value" style="text-align: left; width: 100%; font-style: italic; margin-top: 5px;">${bid.projectAddress}, Pincode: ${bid.projectLocation || 'N/A'}</span></div>
            <div class="detail-row"><span class="detail-label">Accessibility Needs:</span> <span class="detail-value">${toDisplayString(bid.accessibilityNeeds)}</span></div>
            <div class="detail-row"><span class="detail-label">Energy Goals:</span> <span class="detail-value">${toDisplayString(bid.energyEfficiency)}</span></div>
            ${bid.specialRequirements ? `<div class="detail-row" style="flex-direction: column; align-items: flex-start;"><span class="detail-label">Special Requirements:</span> <span class="detail-value" style="text-align: left; width: 100%; margin-top: 5px; color: var(--primary-dark);">${bid.specialRequirements}</span></div>` : ''}
          </div>
        `;

        if (bid.floors && bid.floors.length > 0) {
          html += `
            <div class="detail-group">
              <h3>Floor Plans & Layouts</h3>
              ${bid.floors.map(floor => `
                <div class="floor-card">
                  <strong>Floor ${floor.floorNumber || 'N/A'}</strong>: ${toDisplayString(floor.floorType)} (${floor.floorArea || 'N/A'} sq m)
                  ${floor.floorDescription ? `<p style="font-size: 13px; color: #666; margin-top: 5px;">* ${floor.floorDescription}</p>` : ''}
                  ${floor.floorImagePath ? `<p style="font-size: 12px; margin-top: 5px;">Plan: <a href="${floor.floorImagePath}" target="_blank" style="color: var(--accent-blue); text-decoration: none;">View Plan Image</a></p>` : ''}
                </div>
              `).join('')}
            </div>
          `;
        }

        if (bid.siteFiles && bid.siteFiles.length > 0) {
          const fileLinks = bid.siteFiles.map((file, index) => `<a href="${file}" target="_blank" style="margin-right: 15px; color: var(--success-green); text-decoration: none;">Document ${index + 1}</a>`).join('');
          html += `
            <div class="detail-group">
              <h3>Attached Site Documents</h3>
              <div class="detail-row" style="flex-wrap: wrap; justify-content: flex-start;">${fileLinks}</div>
            </div>
          `;
        }

        return html;
      }

      // Function to decline a company bid
      function declineBid(bidId, companyBidId) {
        if (confirm('Are you sure you want to decline this bid?')) {
          fetch('/customer/decline-bid', { // Use the protected route
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bidId, companyBidId }),
            credentials: 'same-origin'
          })
          .then(response => {
              if (!response.ok) {
                  // Attempt to parse error message from JSON body
                  return response.json().catch(() => ({ error: 'Unknown Server Error' })).then(err => Promise.reject(err));
              }
              return response.json();
          })
          .then(data => {
            if (data.success) {
              alert('Bid declined successfully!');
              window.location.reload();
            } else {
              alert('Error: ' + (data.error || 'Server rejected the request.'));
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('An unexpected error occurred: ' + (error.error || error.message || 'Check console for details.'));
          });
        }
      }
      
      // Initial load: Select the first bid if available
      document.addEventListener('DOMContentLoaded', () => {
          if (customerBidsData.length > 0) {
              // Get the ID of the first bid
              const firstBidId = customerBidsData[0]._id;
              
              // Use a timeout to ensure all DOM elements are registered before calling selectBid
              setTimeout(() => selectBid(firstBidId), 0);
          }
      });
    </script>
  </body>
</html>