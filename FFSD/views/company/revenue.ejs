<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build & Beyond - Revenue Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
    /* --- CORPORATE/ESTABLISHED COLOR PALETTE (Matches other pages) --- */
    :root {
        --primary-accent: #004D7A; /* Deep Navy Blue */
        --primary-accent-hover: #003355; /* Darker Navy */
        --background-light: #F8F9FA; /* Main BG */
        --content-light: #FFFFFF; /* Card BG */
        --text-primary: #212529; /* Main Dark Text */
        --text-secondary: #6C757D; /* Medium Gray Text */
        --highlight-color: #A06700; /* Muted Gold/Amber */
        --border-light: #D1D5DB; /* Soft Border */
        --soft-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --card-radius: 8px;
        --button-secondary-bg: #E9ECEF;
        --status-success-bg: #D4EDDA;
        --status-success-text: #155724;  
        --status-warning-bg: #FFF3CD;    
        --status-warning-text: #856404;  
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Poppins', sans-serif;
    }

    body {
        background-color: var(--background-light);
        color: var(--text-primary);
        line-height: 1.6;
    }

    .main-container {
        padding: 3rem 2.5rem;
        max-width: 1440px;
        margin: 0 auto;
    }

    .page-title {
        margin-bottom: 2rem;
        color: var(--primary-accent);
        font-size: 2.2rem;
        font-weight: 700;
        border-bottom: 3px solid var(--border-light);
        padding-bottom: 0.5rem;
    }

    /* --- STATS CARDS --- */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .stat-card {
        background-color: var(--content-light);
        border-radius: var(--card-radius);
        padding: 2rem;
        box-shadow: var(--soft-shadow);
        border: 1px solid var(--border-light);
        transition: transform 0.3s, box-shadow 0.3s;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 18px rgba(0,0,0,0.15);
    }

    .stat-card h3 {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .stat-card .stat-value {
        font-size: 2.2rem;
        font-weight: 800;
        color: var(--text-primary);
        word-wrap: break-word;
        line-height: 1.2;
    }
    .stat-card.highlight .stat-value {
        color: var(--primary-accent);
    }

    /* --- CONTENT LAYOUT --- */
    .content-wrapper {
        display: grid;
        grid-template-columns: 3fr 1fr;
        gap: 2rem;
        align-items: flex-start;
    }

    .main-section h2 {
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        border-bottom: 2px solid var(--border-light);
        padding-bottom: 0.5rem;
    }

    /* --- PROJECT LIST TABLE --- */
    .project-list-container {
        background-color: var(--content-light);
        border-radius: var(--card-radius);
        box-shadow: var(--soft-shadow);
        border: 1px solid var(--border-light);
        overflow: hidden;
    }
    .project-table {
        width: 100%;
        border-collapse: collapse;
    }
    .project-table th, .project-table td {
        padding: 1rem 1.5rem;
        text-align: left;
        border-bottom: 1px solid var(--border-light);
    }
    .project-table thead {
        background-color: #F8F9FA;
    }
    .project-table th {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
    }
    .project-table tbody tr:hover {
        background-color: #F8F9FA;
    }
    .status-badge {
        font-size: 0.75rem;
        padding: 0.3rem 0.8rem;
        border-radius: 4px;
        font-weight: 600;
        border: 1px solid;
    }
    .status-accepted {
        background-color: var(--status-warning-bg);
        color: var(--status-warning-text);
        border-color: var(--status-warning-text);
    }
    .status-completed {
        background-color: var(--status-success-bg);
        color: var(--status-success-text);
        border-color: var(--status-success-text);
    }
    .btn {
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-secondary {
        background-color: var(--button-secondary-bg);
        color: var(--text-secondary);
        border: 1px solid var(--border-light);
    }
    .btn-secondary:hover {
        background-color: #D1D5DB;
        color: var(--text-primary);
    }

    /* --- SIDEBAR --- */
    .sidebar {
        position: sticky;
        top: 2rem;
    }
    .sidebar .stat-card { margin-bottom: 1.5rem; }
    .sidebar .stat-value { font-size: 2rem; }

    /* --- MODAL STYLING --- */
    .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        align-items: center;
        justify-content: center;
    }
    .modal-content {
        background-color: var(--content-light);
        margin: auto;
        padding: 2rem;
        width: 90%;
        max-width: 800px;
        border-radius: 12px;
        position: relative;
    }
    .close-modal {
        position: absolute;
        right: 1.5rem;
        top: 1rem;
        font-size: 2rem;
        color: var(--text-secondary);
        cursor: pointer;
    }
    .modal-project-name {
        margin-bottom: 2rem;
        color: var(--primary-accent);
        font-size: 1.8rem;
        border-bottom: 2px solid var(--border-light);
        padding-bottom: 0.5rem;
    }
    .detail-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px dashed var(--border-light);
    }
    .detail-label {
        font-weight: 500;
        color: var(--text-secondary);
    }
    .detail-value {
        font-weight: 600;
    }
    .progress-container {
        width: 100%;
        height: 10px;
        background-color: var(--button-secondary-bg);
        border-radius: 5px;
        margin-top: 0.5rem;
    }
    .progress-fill {
        height: 100%;
        background-color: var(--primary-accent);
        border-radius: 5px;
    }
    .no-projects {
        padding: 2rem;
        text-align: center;
        color: var(--text-secondary);
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 900px) {
        .content-wrapper { grid-template-columns: 1fr; }
        .sidebar { position: static; display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    }
    @media (max-width: 600px) {
        .main-container { padding: 1.5rem; }
        .sidebar { grid-template-columns: 1fr; }
    }
    </style>
</head>
<body>
    <%- include('navbar_company') %>
    <div class="main-container">
        <h1 class="page-title">Financial Dashboard</h1>

        <div class="stats-container">
            <div class="stat-card highlight">
                <h3>Total Revenue (Completed)</h3>
                <div class="stat-value">₹<%= metrics.totalRevenue.toLocaleString('en-IN') %></div>
            </div>
            <div class="stat-card">
                <h3>Ongoing Project Value</h3>
                <div class="stat-value">₹<%= metrics.ongoingProjectValue.toLocaleString('en-IN') %></div>
            </div>
            <div class="stat-card">
                <h3>Completed Projects</h3>
                <div class="stat-value"><%= metrics.completedProjects %></div>
            </div>
            <div class="stat-card">
                <h3>Average Project Value</h3>
                <div class="stat-value">₹<%= Math.round(metrics.averageProjectValue).toLocaleString('en-IN') %></div>
            </div>
        </div>

        <div class="content-wrapper">
            <div class="main-section">
                <h2>All Projects</h2>
                <div class="project-list-container">
                    <table class="project-table">
                        <thead>
                            <tr>
                                <th>Project Name</th>
                                <th>Client</th>
                                <th>Completed On</th>
                                <th>Status</th>
                                <th>Final Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (projects && projects.length > 0) { %>
                                <% projects.forEach(project => { %>
                                    <tr>
                                        <td><%= project.projectName %></td>
                                        <td><%= project.customerName %></td>
                                        <td><%= project.status === 'completed' ? new Date(project.updatedAt).toLocaleDateString('en-IN') : 'Ongoing' %></td>
                                        <td><span class="status-badge status-<%= project.status %>"><%= project.status %></span></td>
                                        
                                        <td>₹<%= (project.paymentDetails && project.paymentDetails.totalAmount) ? project.paymentDetails.totalAmount.toLocaleString('en-IN') : '0' %></td>
                                        
                                        <td><button class="btn btn-secondary view-details" data-id="<%= project._id %>">Details</button></td>
                                    </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="6" class="no-projects">No projects found.</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="sidebar">
                <div class="stat-card">
                    <h3>Revenue (This Month)</h3>
                    <div class="stat-value">₹<%= metrics.revenueThisMonth.toLocaleString('en-IN') %></div>
                </div>
                <div class="stat-card">
                    <h3>Revenue (This Quarter)</h3>
                    <div class="stat-value">₹<%= metrics.revenueThisQuarter.toLocaleString('en-IN') %></div>
                </div>
                <div class="stat-card">
                    <h3>Annual Revenue (YTD)</h3>
                    <div class="stat-value">₹<%= metrics.revenueThisYear.toLocaleString('en-IN') %></div>
                </div>
            </div>
        </div>
    </div>

    <div id="project-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 id="modal-project-name" class="modal-project-name"></h2>
            <div id="modal-project-details"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const projectsData = <%- JSON.stringify(projects || []) %>;
            const modal = document.getElementById('project-modal');
            const closeModal = document.querySelector('.close-modal');
            const modalProjectName = document.getElementById('modal-project-name');
            const modalProjectDetails = document.getElementById('modal-project-details');

            document.querySelectorAll('.view-details').forEach(button => {
                button.addEventListener('click', function() {
                    const projectId = this.getAttribute('data-id');
                    const project = projectsData.find(p => p._id === projectId);
                    if (!project) return;

                    modalProjectName.textContent = project.projectName;

                   const totalAmount = project.paymentDetails?.totalAmount || 0;
                    const receivedAmount = project.paymentDetails?.amountPaidToCompany || 0;
                    const pendingAmount = totalAmount - receivedAmount;
                    
                    const endDate = project.status === 'completed' 
                        ? new Date(project.updatedAt).toLocaleDateString('en-IN') 
                        : (project.projectTimeline ? new Date(new Date(project.createdAt).setMonth(new Date(project.createdAt).getMonth() + project.projectTimeline)).toLocaleDateString('en-IN') : 'N/A');

                    modalProjectDetails.innerHTML = `
                        <div class="detail-row">
                            <div class="detail-label">Client</div>
                            <div class="detail-value">${project.customerName || 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Location</div>
                            <div class="detail-value">${project.projectAddress || 'N/A'}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Total Cost</div>
                            <div class="detail-value">₹${totalAmount.toLocaleString('en-IN')}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Amount Received</div>
                            <div class="detail-value">₹${receivedAmount.toLocaleString('en-IN')}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Pending Amount</div>
                            <div class="detail-value">₹${pendingAmount.toLocaleString('en-IN')}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Start Date</div>
                            <div class="detail-value">${new Date(project.createdAt).toLocaleDateString('en-IN')}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">${project.status === 'completed' ? 'End Date' : 'Est. End Date'}</div>
                            <div class="detail-value">${endDate}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Completion</div>
                            <div class="detail-value">
                                ${project.completionPercentage || 0}%
                                <div class="progress-container">
                                    <div class="progress-fill" style="width: ${project.completionPercentage || 0}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">Description</div>
                            <div class="detail-value">${project.specialRequirements || project.proposal?.description || 'No description available.'}</div>
                        </div>
                    `;

                    modal.style.display = 'flex';
                });
            });

            closeModal.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            window.addEventListener('click', event => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>